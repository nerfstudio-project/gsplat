cmake_minimum_required(VERSION 3.18)
project(PointCloudCompression LANGUAGES CXX CUDA)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Load dependency paths (auto-generated by install_dependencies.sh)
set(DEPENDENCY_PATHS_FILE "${CMAKE_CURRENT_SOURCE_DIR}/dependency_paths.cmake")
if(EXISTS "${DEPENDENCY_PATHS_FILE}")
    include("${DEPENDENCY_PATHS_FILE}")
    message(STATUS "Loaded dependency paths from ${DEPENDENCY_PATHS_FILE}")
else()
    # Fallback to default locations if dependency_paths.cmake doesn't exist
    set(PCL_VERSION "1.15.1" CACHE STRING "PCL version")
    set(DRACO_VERSION "1.5.7" CACHE STRING "Draco version")
    set(OPEN3D_VERSION "v0.19.0" CACHE STRING "Open3D version")

    set(PCL_ROOT "$ENV{HOME}/.local" CACHE PATH "PCL installation directory")
    set(DRACO_ROOT "$ENV{HOME}/.local" CACHE PATH "Draco installation directory")
    set(Open3D_ROOT "$ENV{HOME}/.local" CACHE PATH "Open3D installation directory")
    message(WARNING "dependency_paths.cmake not found. Using default paths. Run install_dependencies.sh first.")
endif()

# Add custom paths to CMAKE_PREFIX_PATH
list(APPEND CMAKE_PREFIX_PATH ${PCL_ROOT} ${DRACO_ROOT} ${Open3D_ROOT})

# Find PCL
find_package(PCL REQUIRED)
if(PCL_FOUND)
    include_directories(${PCL_INCLUDE_DIRS})
    link_directories(${PCL_LIBRARY_DIRS})
    add_definitions(${PCL_DEFINITIONS})
    message(STATUS "PCL found: ${PCL_VERSION} at ${PCL_ROOT}")
else()
    message(FATAL_ERROR "PCL not found. Please install PCL or set PCL_ROOT")
endif()

# Find Open3D
find_package(Open3D REQUIRED)
if(Open3D_FOUND)
    message(STATUS "Open3D found at ${Open3D_ROOT}")
else()
    message(FATAL_ERROR "Open3D not found. Please install Open3D or set Open3D_ROOT")
endif()

# Find Draco
find_package(draco REQUIRED)
if(draco_FOUND)
    message(STATUS "Draco found at ${DRACO_ROOT}")
else()
    message(FATAL_ERROR "Draco not found. Please install Draco or set DRACO_ROOT")
endif()

# Find jsoncpp (required for Open3D octree JSON serialization)
find_package(PkgConfig REQUIRED)
if(NOT PkgConfig_FOUND)
    message(FATAL_ERROR "PkgConfig not found. Please install PkgConfig")
endif()
pkg_check_modules(JSONCPP jsoncpp REQUIRED)
if(JSONCPP_FOUND)
    message(STATUS "jsoncpp found: version ${JSONCPP_VERSION}")
    message(STATUS "jsoncpp libraries: ${JSONCPP_LIBRARIES}")
    message(STATUS "jsoncpp include dirs: ${JSONCPP_INCLUDE_DIRS}")
    include_directories(${JSONCPP_INCLUDE_DIRS})
else()
    message(FATAL_ERROR "jsoncpp not found. Please install jsoncpp")
endif()

# Include directories
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)

# Source files
set(SOURCES
    src/main.cpp
    src/pcl_compression.cpp
    src/open3d_compression.cpp
    src/draco_compression.cpp
    src/gpu_octree_compression.cpp
    src/utils.cpp
    src/timer.cpp
)

# Create executable
add_executable(pointcloud_compression ${SOURCES})

# Set gpu_octree_compression.cpp to compile as CUDA code
set_source_files_properties(src/gpu_octree_compression.cpp PROPERTIES
    LANGUAGE CUDA
)

# Set CUDA properties for pointcloud_compression
set_target_properties(pointcloud_compression PROPERTIES
    CUDA_SEPARABLE_COMPILATION ON
    CUDA_RUNTIME_LIBRARY Shared
)

# Find CUDA installation path
# Priority: 1) User-provided CUDA_ROOT, 2) Environment variable, 3) Auto-detect
if(NOT CUDA_ROOT)
    # Check environment variable
    if(DEFINED ENV{CUDA_ROOT})
        set(CUDA_ROOT $ENV{CUDA_ROOT})
        message(STATUS "Using CUDA_ROOT from environment: ${CUDA_ROOT}")
    elseif(DEFINED ENV{CUDA_HOME})
        set(CUDA_ROOT $ENV{CUDA_HOME})
        message(STATUS "Using CUDA_ROOT from CUDA_HOME: ${CUDA_ROOT}")
    else()
        # Auto-detect using CUDAToolkit
        find_package(CUDAToolkit QUIET)
        if(CUDAToolkit_FOUND)
            get_filename_component(CUDA_ROOT "${CUDAToolkit_BIN_DIR}" DIRECTORY)
            message(STATUS "Auto-detected CUDA_ROOT: ${CUDA_ROOT}")
        else()
            # Try common locations
            foreach(cuda_path
                "/usr/local/cuda"
                "/usr/local/cuda-12.1"
                "/usr/local/cuda-12.0"
                "/usr/local/cuda-11.8"
                "/opt/cuda")
                if(EXISTS "${cuda_path}/include/cuda_runtime.h")
                    set(CUDA_ROOT "${cuda_path}")
                    message(STATUS "Found CUDA at: ${CUDA_ROOT}")
                    break()
                endif()
            endforeach()
        endif()
    endif()
endif()

# Validate CUDA_ROOT
if(NOT CUDA_ROOT OR NOT EXISTS "${CUDA_ROOT}/include/cuda_runtime.h")
    message(FATAL_ERROR "CUDA not found. Please set CUDA_ROOT via:\n"
                        "  1) CMake option: -DCUDA_ROOT=/path/to/cuda\n"
                        "  2) Environment variable: export CUDA_ROOT=/path/to/cuda")
endif()

message(STATUS "Using CUDA from: ${CUDA_ROOT}")
target_include_directories(pointcloud_compression PRIVATE
    ${CUDA_ROOT}/include
)

# Find and link CUDA runtime library
find_library(CUDA_CUDART cudart
    PATHS
    ${CUDA_ROOT}/lib64
    ${CUDA_ROOT}/lib
    /usr/local/cuda/lib64
    /usr/local/cuda/lib
)

if(CUDA_CUDART)
    target_link_libraries(pointcloud_compression ${CUDA_CUDART})
    message(STATUS "CUDA runtime library found: ${CUDA_CUDART}")
else()
    message(FATAL_ERROR "CUDA runtime library (cudart) not found in ${CUDA_ROOT}")
endif()

# Link libraries
target_link_libraries(pointcloud_compression 
    ${PCL_LIBRARIES}
    Open3D::Open3D
    draco::draco
    ${JSONCPP_LIBRARIES}
    ffi
)

# GPU Octree executable (requires CUDA)
add_executable(gpu_octree_compression src/gpu_octree.cpp)

# Set the source file to compile as CUDA code
set_source_files_properties(src/gpu_octree.cpp PROPERTIES
    LANGUAGE CUDA
)

# Set CUDA properties
set_target_properties(gpu_octree_compression PROPERTIES
    CUDA_SEPARABLE_COMPILATION ON
    CUDA_RUNTIME_LIBRARY Shared
)

# Set CUDA include directories (reuse CUDA_ROOT from above)
target_include_directories(gpu_octree_compression PRIVATE
    ${CUDA_ROOT}/include
)

# Link CUDA runtime library (already found above)
if(CUDA_CUDART)
    target_link_libraries(gpu_octree_compression ${CUDA_CUDART})
else()
    message(FATAL_ERROR "CUDA runtime library not available")
endif()

target_link_libraries(gpu_octree_compression 
    ${PCL_LIBRARIES}
    Open3D::Open3D
    draco::draco
    ${JSONCPP_LIBRARIES}
    ffi
)

# Compiler-specific options
if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
    target_compile_options(pointcloud_compression PRIVATE -Wall -Wextra)
endif()
